<!doctype html>
<html lang="{{ site.lang | default: 'es' }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% if page.title %}{{ page.title }} · {% endif %}{{ site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description | escape }}" />
    <link rel="icon" href="{{ '/favicon.ico' | relative_url }}" sizes="any" />
    <link rel="alternate" type="application/rss+xml" title="{{ site.title | escape }}" href="https://feeds.feedburner.com/daizansoriano/podcast" />
    <style>
      :root {
        --color-text: #1a1a1a;
        --color-text-light: #666;
        --color-border: #e5e5e5;
        --color-bg-subtle: #f8f9fa;
        --color-bg: #ffffff;
        --color-accent: #2d5a7b;
        --max-width: 840px;
        --spacing: clamp(1rem, 3vw, 1.5rem);
      }
      
      * { box-sizing: border-box; }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        margin: 0;
        line-height: 1.65;
        color: var(--color-text);
        background: #fff;
        font-size: 17px;
      }
      
      header, main, footer {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: var(--spacing);
      }
      
      header {
        border-bottom: 1px solid var(--color-border);
        padding-top: 2rem;
        padding-bottom: 1.5rem;
      }
      
      .header-content {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }
      
      .podcast-image {
        flex-shrink: 0;
        width: 120px;
        height: 120px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        object-fit: cover;
        background: var(--color-bg-subtle);
      }
      
      .header-text {
        flex: 1;
      }
      
      .site-title {
        font-size: clamp(1.5rem, 4vw, 2rem);
        font-weight: 600;
        letter-spacing: -0.02em;
        margin: 0 0 0.25rem 0;
      }
      
      .site-description {
        color: var(--color-text-light);
        font-size: 0.95rem;
        max-width: 600px;
        line-height: 1.5;
      }
      
      nav {
        margin-top: 1rem;
        font-size: 0.95rem;
      }
      
      nav a {
        color: var(--color-accent);
        text-decoration: none;
        padding: 0.25rem 0;
        border-bottom: 2px solid transparent;
        transition: border-color 0.2s;
      }
      
      nav a:hover {
        border-bottom-color: var(--color-accent);
      }
      
      main {
        padding-top: 2rem;
        padding-bottom: 3rem;
      }
      
      footer {
        border-top: 1px solid var(--color-border);
        color: var(--color-text-light);
        font-size: 0.9rem;
        padding-top: 1.5rem;
        padding-bottom: 2rem;
      }
      
      a { color: inherit; text-decoration: none; }
      
      /* Search Styles */
      .search-container {
        margin-bottom: 3rem;
      }

      .search-box {
        position: relative;
        max-width: 600px;
        margin: 0 auto 1rem;
      }

      #search-input {
        width: 100%;
        padding: 0.75rem 3rem 0.75rem 0.75rem;
        font-size: 1rem;
        font-family: inherit;
        border: 2px solid var(--color-border);
        border-radius: 8px;
        background: var(--color-bg);
        color: var(--color-text);
        transition: border-color 0.2s, box-shadow 0.2s;
        position: relative;
        z-index: 1;
        pointer-events: auto;
      }

      #search-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px rgba(45, 90, 123, 0.1);
      }

      .clear-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        padding: 0;
        background: none;
        border: none;
        color: var(--color-text-light);
        cursor: pointer;
        z-index: 2;
        border-radius: 4px;
        font-size: 1.25rem;
        line-height: 1;
        transition: background-color 0.2s, color 0.2s;
      }

      .clear-btn:hover {
        background: var(--color-bg-subtle);
        color: var(--color-text);
      }

      .search-info {
        text-align: center;
        padding: 0.75rem;
        margin-bottom: 1.5rem;
        background: var(--color-bg-subtle);
        border-radius: 6px;
        color: var(--color-text-light);
        font-size: 0.95rem;
      }

      .no-results {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--color-text-light);
      }

      .no-results p {
        font-size: 1.1rem;
      }

      mark {
        background: rgba(255, 235, 59, 0.4);
        color: var(--color-text);
        padding: 0.1em 0.2em;
        border-radius: 2px;
      }
      
      h1, h2, h3 {
        line-height: 1.3;
        letter-spacing: -0.015em;
        margin-top: 2rem;
        margin-bottom: 1rem;
      }
      
      h1 { font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 600; margin-top: 0; }
      h2 { font-size: 1.5rem; font-weight: 600; }
      h3 { font-size: 1.25rem; font-weight: 600; }
      
      .episode {
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--color-border);
      }
      
      .episode:first-of-type { padding-top: 0; }
      .episode:last-of-type { border-bottom: none; }
      
      .episode-title {
        font-size: 1.15rem;
        font-weight: 600;
        line-height: 1.4;
        margin-bottom: 0.4rem;
      }
      
      .episode-title a {
        color: var(--color-text);
        border-bottom: 2px solid transparent;
        transition: border-color 0.2s;
      }
      
      .episode-title a:hover {
        border-bottom-color: var(--color-accent);
      }
      
      .meta {
        color: var(--color-text-light);
        font-size: 0.9rem;
        margin: 0.5rem 0;
      }
      
      .episode-description {
        margin-top: 0.75rem;
        color: var(--color-text);
        line-height: 1.6;
      }

      /* Imágenes y figuras: responsivas y centradas */
      img {
        max-width: 100%;
        height: auto;
      }

      figure {
        margin: 1.5rem 0;
      }

      figure img {
        display: block;
        margin: 0 auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      }

      figcaption {
        color: var(--color-text-light);
        font-size: 0.9rem;
        text-align: center;
        margin-top: 0.5rem;
      }

      /* Vídeo embebido (YouTube/Vimeo/iframe) responsivo */
      .video {
        position: relative;
        width: 100%;
        padding-top: 56.25%; /* 16:9 */
        margin: 1.5rem 0;
      }

      .video iframe,
      .video video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
        border-radius: 8px;
      }

      /* Si se pega un iframe/video sin wrapper, al menos que no desborde */
      iframe,
      video {
        max-width: 100%;
      }
      
      audio {
        width: 100%;
        margin: 1.5rem 0;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      
      audio::-webkit-media-controls-panel {
        background-color: var(--color-bg-subtle);
      }
      
      code {
        background: var(--color-bg-subtle);
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
      }
      
      pre {
        background: var(--color-bg-subtle);
        padding: 1rem;
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--color-border);
      }

      /* Versos importados (antes venían como <pre>) */
      .wp-block-verse {
        background: var(--color-bg-subtle);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--color-border);
        margin: 1.5rem 0;
        line-height: 1.7;
      }
      
      pre code {
        background: none;
        padding: 0;
      }
      
      article {
        max-width: 680px;
      }
      
      article > div {
        margin-top: 2rem;
      }
      
      time {
        font-variant-numeric: tabular-nums;
      }
      
      .pagination {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--color-border);
      }
      
      .pagination-info {
        color: var(--color-text-light);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        text-align: center;
      }
      
      .pagination-links {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .pagination-btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: background-color 0.2s;
      }
      
      .pagination-btn:not(.disabled) {
        background: var(--color-bg-subtle);
        color: var(--color-accent);
        font-weight: 500;
      }
      
      .pagination-btn:not(.disabled):hover {
        background: var(--color-accent);
        color: white;
      }
      
      .pagination-btn.disabled {
        color: var(--color-text-light);
        opacity: 0.4;
        cursor: not-allowed;
      }
      
      .pagination-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 2.5rem;
        height: 2.5rem;
        padding: 0 0.5rem;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: background-color 0.2s;
      }
      
      .pagination-number:hover {
        background: var(--color-bg-subtle);
      }
      
      .pagination-number.current {
        background: var(--color-accent);
        color: white;
        font-weight: 600;
      }
      
      @media (max-width: 640px) {
        body { font-size: 16px; }
        .site-title { font-size: 1.5rem; }
        .episode { padding: 1.25rem 0; }
        h1 { font-size: 1.75rem; }
        header { padding-top: 1.25rem; padding-bottom: 1rem; }
        .header-content { flex-direction: column; align-items: flex-start; gap: 1rem; }
        .podcast-image { width: 96px; height: 96px; }
        nav { margin-top: 0.75rem; }
        nav a { display: inline-block; }
        .pagination-links { gap: 0.25rem; }
        .pagination-btn { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .pagination-number { min-width: 2rem; height: 2rem; font-size: 0.85rem; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-content">
        <img src="{{ '/assets/daizan.jpg' | relative_url }}" alt="{{ site.title }}" class="podcast-image" loading="eager" decoding="async">
        <div class="header-text">
          <h1 class="site-title"><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
          <p class="site-description">{{ site.description }}</p>
          <nav>
            <a href="{{ '/' | relative_url }}">Episodios</a> ·
            <a href="{{ '/about/' | relative_url }}">Acerca de</a> ·
            <a href="{{ '/enlaces/' | relative_url }}">Enlaces</a> ·
            <a href="{{ '/lista-correo/' | relative_url }}">Lista de correo</a> ·
            <a href="https://feeds.feedburner.com/daizansoriano/podcast">Feed RSS</a>
          </nav>
        </div>
      </div>
    </header>

    <main>
      {{ content }}
    </main>

    <footer>
      <div style="margin-bottom: 1rem;">
        <a href="https://creativecommons.org/licenses/by-nd/4.0/deed.es" 
           target="_blank" 
           rel="license noopener noreferrer"
           style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--color-text-light); text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s;"
           onmouseover="this.style.borderBottomColor='var(--color-text-light)'"
           onmouseout="this.style.borderBottomColor='transparent'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
          </svg>
          <span>Licencia CC BY-ND 4.0</span>
        </a>
        <div style="font-size: 0.85rem; margin-top: 0.5rem; line-height: 1.5;">
          Este contenido está bajo licencia <strong>Creative Commons Atribución-SinDerivadas 4.0 Internacional</strong>.<br>
          Puedes compartirlo libremente dando el crédito apropiado, pero no crear obras derivadas.
        </div>
      </div>
      <div>© {{ "now" | date: "%Y" }} Daizan Soriano · v{{ site.version }}</div>
    </footer>

    <script>
      (function () {
        const STORAGE_PREFIX = 'audioteca:audio-progress:';
        const SAVE_EVERY_MS = 5000;
        const CLEAR_IF_WITHIN_END_SECONDS = 10;
        const MIN_RESTORE_SECONDS = 3;

        function formatTime(totalSeconds) {
          if (!Number.isFinite(totalSeconds) || totalSeconds < 0) return '';
          const s = Math.floor(totalSeconds);
          const hours = Math.floor(s / 3600);
          const minutes = Math.floor((s % 3600) / 60);
          const seconds = s % 60;
          const pad2 = (n) => String(n).padStart(2, '0');
          return hours > 0 ? `${hours}:${pad2(minutes)}:${pad2(seconds)}` : `${minutes}:${pad2(seconds)}`;
        }

        function safeJsonParse(value) {
          try {
            return JSON.parse(value);
          } catch (_) {
            return null;
          }
        }

        function safeGet(key) {
          try {
            return localStorage.getItem(key);
          } catch (_) {
            return null;
          }
        }

        function safeSet(key, value) {
          try {
            localStorage.setItem(key, value);
          } catch (_) {
            // Ignorar (modo privado, cuota llena, etc.)
          }
        }

        function safeRemove(key) {
          try {
            localStorage.removeItem(key);
          } catch (_) {
            // Ignorar
          }
        }

        function getAudioKey(audio) {
          const src = audio.currentSrc || audio.src;
          if (!src) return null;
          let normalized;
          try {
            normalized = new URL(src, window.location.href).href;
          } catch (_) {
            normalized = src;
          }
          return STORAGE_PREFIX + normalized;
        }

        function shouldClearProgress(currentTime, duration) {
          if (!Number.isFinite(currentTime) || currentTime <= 0) return true;
          if (!Number.isFinite(duration) || duration <= 0) return false;
          return currentTime >= Math.max(0, duration - CLEAR_IF_WITHIN_END_SECONDS);
        }

        function attach(audio) {
          const key = getAudioKey(audio);
          if (!key) return;

          let lastSavedAt = 0;
          let restored = false;
          let promptEl = null;
          let pendingSeek = null;

          function saveProgress(force) {
            const now = Date.now();
            if (!force && now - lastSavedAt < SAVE_EVERY_MS) return;
            lastSavedAt = now;

            const t = audio.currentTime;
            const d = audio.duration;
            if (shouldClearProgress(t, d)) {
              safeRemove(key);
              return;
            }

            safeSet(
              key,
              JSON.stringify({
                t: t,
                d: Number.isFinite(d) ? d : null,
                updatedAt: now,
                page: window.location.pathname
              })
            );
          }

          function removePrompt() {
            if (promptEl && promptEl.parentNode) promptEl.parentNode.removeChild(promptEl);
            promptEl = null;
          }

          function showResumePrompt(seconds) {
            if (promptEl) return;
            const timeLabel = formatTime(seconds);
            if (!timeLabel) return;

            const wrapper = document.createElement('div');
            wrapper.className = 'audio-resume';
            wrapper.style.marginTop = '0.5rem';
            wrapper.style.padding = '0.75rem';
            wrapper.style.border = '1px solid var(--color-border)';
            wrapper.style.borderRadius = '8px';
            wrapper.style.background = 'var(--color-bg-subtle)';
            wrapper.style.color = 'var(--color-text)';
            wrapper.style.display = 'flex';
            wrapper.style.flexWrap = 'wrap';
            wrapper.style.alignItems = 'center';
            wrapper.style.gap = '0.75rem';

            const text = document.createElement('div');
            text.style.flex = '1 1 auto';
            text.innerHTML = `Has escuchado hasta <strong>${timeLabel}</strong>. ¿Continuar?`;

            const actions = document.createElement('div');
            actions.style.display = 'inline-flex';
            actions.style.gap = '0.5rem';
            actions.style.flex = '0 0 auto';

            const btnContinue = document.createElement('button');
            btnContinue.type = 'button';
            btnContinue.textContent = 'Continuar';
            btnContinue.style.padding = '0.45rem 0.75rem';
            btnContinue.style.borderRadius = '6px';
            btnContinue.style.border = '1px solid var(--color-border)';
            btnContinue.style.background = 'var(--color-bg)';
            btnContinue.style.cursor = 'pointer';

            const btnRestart = document.createElement('button');
            btnRestart.type = 'button';
            btnRestart.textContent = 'Empezar desde cero';
            btnRestart.style.padding = '0.45rem 0.75rem';
            btnRestart.style.borderRadius = '6px';
            btnRestart.style.border = '1px solid var(--color-border)';
            btnRestart.style.background = 'var(--color-bg)';
            btnRestart.style.cursor = 'pointer';

            btnContinue.addEventListener('click', () => {
              restored = true;
              removePrompt();
              // Con preload="none", puede que aún no haya metadata; diferimos el seek.
              if (audio.readyState >= 1) {
                try {
                  audio.currentTime = seconds;
                } catch (_) {}
              } else {
                pendingSeek = seconds;
              }
              // Intentar reproducir: el click cuenta como gesto del usuario.
              const p = audio.play();
              if (p && typeof p.catch === 'function') p.catch(() => {});
            });

            btnRestart.addEventListener('click', () => {
              safeRemove(key);
              restored = true;
              removePrompt();
              try {
                audio.currentTime = 0;
              } catch (_) {}
            });

            actions.appendChild(btnContinue);
            actions.appendChild(btnRestart);
            wrapper.appendChild(text);
            wrapper.appendChild(actions);

            audio.insertAdjacentElement('afterend', wrapper);
            promptEl = wrapper;
          }

          function restoreProgressWithPrompt() {
            if (restored) return;
            const raw = safeGet(key);
            if (!raw) return;
            const data = safeJsonParse(raw);
            if (!data || !Number.isFinite(data.t)) return;

            const t = data.t;
            if (t < MIN_RESTORE_SECONDS) return;

            showResumePrompt(t);
          }

          // Mostrar el prompt al cargar, incluso con preload="none".
          restoreProgressWithPrompt();

          audio.addEventListener(
            'loadedmetadata',
            () => {
              // Si ya estamos prácticamente al final, limpiar progreso.
              const raw = safeGet(key);
              const data = raw ? safeJsonParse(raw) : null;
              if (data && Number.isFinite(data.t)) {
                const d = audio.duration;
                if (Number.isFinite(d) && d > 0 && data.t >= Math.max(0, d - CLEAR_IF_WITHIN_END_SECONDS)) {
                  safeRemove(key);
                }
              }

              if (pendingSeek != null) {
                const seconds = pendingSeek;
                pendingSeek = null;
                try {
                  audio.currentTime = seconds;
                } catch (_) {}
              }
            },
            { passive: true }
          );

          audio.addEventListener('timeupdate', () => saveProgress(false), { passive: true });
          audio.addEventListener('pause', () => saveProgress(true), { passive: true });
          audio.addEventListener(
            'play',
            () => {
              if (promptEl) {
                restored = true;
                removePrompt();
              }
            },
            { passive: true }
          );

          audio.addEventListener(
            'ended',
            () => {
              removePrompt();
              safeRemove(key);
            },
            { passive: true }
          );

          document.addEventListener(
            'visibilitychange',
            () => {
              if (document.visibilityState === 'hidden') saveProgress(true);
            },
            { passive: true }
          );

          window.addEventListener(
            'pagehide',
            () => {
              saveProgress(true);
            },
            { passive: true }
          );
          window.addEventListener('beforeunload', () => saveProgress(true));
        }

        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('audio').forEach(attach);
        });
      })();
    </script>
  </body>
</html>

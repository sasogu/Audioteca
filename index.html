---
layout: default
title: "Episodios"
---

<div class="search-container">
  <div class="search-box">
          <input type="search" 
            id="search-input" 
            placeholder="üîç Buscar episodios (min. 2 letras)" 
        autocomplete="off"
        aria-label="Buscar episodios"
        tabindex="0"
        autofocus>
    <button id="clear-search" class="clear-btn" style="display: none;" aria-label="Limpiar b√∫squeda">
      ‚úï
    </button>
  </div>
  <div id="search-results" class="search-results" style="display: none;"></div>
  <div id="search-info" class="search-info" style="display: none;"></div>
</div>

<div id="episodes-list">
{% if paginator.posts.size == 0 %}
<p>No hay episodios todav√≠a. Crea tu primer archivo en <code>_posts/</code>.</p>
{% else %}
  {% for post in paginator.posts %}
    {% if post.categories contains 'podcast' %}
<article class="episode">
  <h2 class="episode-title"><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h2>
  <div class="meta">
    <time datetime="{{ post.date | date_to_xmlschema }}">{{ post.date | date: "%d de %B de %Y" }}</time>
    {% if post.episode %} ¬∑ Episodio {{ post.episode }}{% endif %}
    {% if post.season %} ¬∑ Temporada {{ post.season }}{% endif %}
    {% if post.duration %} ¬∑ {{ post.duration }}{% endif %}
  </div>
  {% if post.description %}
    <div class="episode-description">{{ post.description }}</div>
  {% endif %}
</article>
    {% endif %}
  {% endfor %}

  {% if paginator.total_pages > 1 %}
<nav class="pagination" aria-label="Paginaci√≥n">
  <div class="pagination-info">
    P√°gina {{ paginator.page }} de {{ paginator.total_pages }}
  </div>
  <div class="pagination-links">
    {% if paginator.previous_page %}
      <a href="{{ paginator.previous_page_path | relative_url }}" class="pagination-btn">‚Üê Anterior</a>
    {% else %}
      <span class="pagination-btn disabled">‚Üê Anterior</span>
    {% endif %}

    {% if paginator.page_trail %}
      {% for trail in paginator.page_trail %}
        {% if trail.num == paginator.page %}
          <span class="pagination-number current">{{ trail.num }}</span>
        {% else %}
          <a href="{{ trail.path | relative_url }}" class="pagination-number">{{ trail.num }}</a>
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if paginator.next_page %}
      <a href="{{ paginator.next_page_path | relative_url }}" class="pagination-btn">Siguiente ‚Üí</a>
    {% else %}
      <span class="pagination-btn disabled">Siguiente ‚Üí</span>
    {% endif %}
  </div>
</nav>
  {% endif %}
{% endif %}
</div>

<script>
(function() {
  let searchData = [];
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const searchInfo = document.getElementById('search-info');
  const clearBtn = document.getElementById('clear-search');
  const episodesList = document.getElementById('episodes-list');
  const pagination = document.querySelector('.pagination');

  // Forzar foco cuando el DOM est√© listo y al cargar
  document.addEventListener('DOMContentLoaded', () => {
    if (searchInput) {
      console.log('DOMContentLoaded: enfocando el buscador');
      try { searchInput.focus(); } catch (e) {}
    }
  });
  window.addEventListener('load', () => {
    if (searchInput) {
      console.log('load: enfocando el buscador (fallback)');
      try { searchInput.focus(); } catch (e) {}
    }
  });

  // Asegurar foco inicial en el input y registrar interacci√≥n
  if (searchInput) {
    try { searchInput.focus(); } catch (e) {}
    searchInput.addEventListener('focus', () => {
      console.log('Buscador: focus recibido');
    });
    searchInput.addEventListener('click', () => {
      console.log('Buscador: clic sobre el campo');
    });
  } else {
    console.warn('Search input not found');
  }

  // Cargar datos de b√∫squeda
  fetch('{{ site.baseurl }}/search.json')
    .then(response => response.json())
    .then(data => {
      searchData = data;
      console.log('Buscador: √≠ndice cargado ‚Üí', Array.isArray(data) ? data.length : 0, 'episodios');
    })
    .catch(err => {
      console.error('Buscador: error cargando √≠ndice', err);
    });

  // Funci√≥n de b√∫squeda
  function search(query) {
    if (!query || query.length < 2) {
      clearSearch();
      return;
    }

    const lowerQuery = query.toLowerCase();
    const results = searchData.filter(item => {
      return item.title.toLowerCase().includes(lowerQuery) ||
             item.content.toLowerCase().includes(lowerQuery);
    });

    displayResults(results, query);
  }

  // Mostrar resultados
  function displayResults(results, query) {
    episodesList.style.display = 'none';
    if (pagination) pagination.style.display = 'none';
    searchResults.style.display = 'block';
    searchInfo.style.display = 'block';
    clearBtn.style.display = 'flex';

    searchInfo.innerHTML = `<strong>${results.length}</strong> resultado${results.length !== 1 ? 's' : ''} para "<strong>${escapeHtml(query)}</strong>"`;

    if (results.length === 0) {
      searchResults.innerHTML = '<div class="no-results"><p>No se encontraron episodios. Intenta con otras palabras clave.</p></div>';
      return;
    }

    const html = results.map(item => `
      <article class="episode">
        <h2 class="episode-title">
          <a href="${item.url}">${highlightMatch(item.title, query)}</a>
        </h2>
        <div class="meta">
          <time>${item.date}</time>
        </div>
        <div class="episode-description">
          ${highlightMatch(item.excerpt, query)}
        </div>
      </article>
    `).join('');

    searchResults.innerHTML = html;
  }

  // Limpiar b√∫squeda
  function clearSearch() {
    searchInput.value = '';
    searchResults.style.display = 'none';
    searchInfo.style.display = 'none';
    clearBtn.style.display = 'none';
    episodesList.style.display = 'block';
    if (pagination) pagination.style.display = 'block';
  }

  // Resaltar coincidencias
  function highlightMatch(text, query) {
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }

  // Escapar HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Escapar caracteres especiales regex
  function escapeRegex(text) {
    return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Event listeners
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      console.log('Buscador: valor actual ->', e.target.value);
      search(e.target.value);
    });
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      clearSearch();
      if (searchInput) searchInput.focus();
    });
  }

  // Limpiar con Escape
  if (searchInput) {
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        clearSearch();
      }
    });
  }
})();
</script>
